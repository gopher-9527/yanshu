# Yanshu 语音助手架构设计

## 一、系统概述

Yanshu 是一个基于 AI Agent 的语音助手系统，采用**瘦客户端 + 智能服务端**的架构模式。

### 核心设计理念

- **MCU 终端**：纯语音 I/O 设备，只负责音频采集、播放和用户交互
- **服务端**：所有智能逻辑（ASR（Automatic Speech Recognition）、Agent、LLM、TTS（Text To Speech）、会话管理）均在服务端完成
- **通信协议**：自定义二进制协议 + TCP 长连接，低延迟、高可靠

### 系统定位

```
┌─────────────────┐
│  MCU 终端       │  ← 语音 I/O 设备（瘦客户端）
│  - 音频采集     │
│  - 音频播放     │
│  - 按键/LED     │
│  - 状态机       │
└────────┬────────┘
         │ TCP 长连接
         │ 自定义二进制协议
         ↓
┌──────────────────────────┐
│  服务端（智能大脑）      │
│  - ASR (语音识别)        │
│  - Agent (决策调度)      │
│  - LLM (语言理解)        │
│  - TTS (语音合成)        │
│  - 会话管理              │
└──────────────────────────┘
```

## 二、系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      MCU 终端层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  音频采集    │  │  音频播放    │  │  用户交互    │     │
│  │  (I2S/PDM)   │  │  (DAC/I2S)   │  │  (按键/LED)  │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
│         │                  │                  │              │
│         └──────────────────┴──────────────────┘              │
│                            │                                 │
│                   ┌────────▼────────┐                        │
│                   │   状态机 (FSM)  │                        │
│                   │  - IDLE         │                        │
│                   │  - CAPTURE      │                        │
│                   │  - UPLOAD       │                        │
│                   │  - WAIT_AUDIO   │                        │
│                   │  - PLAY         │                        │
│                   └────────┬────────┘                        │
│                            │                                 │
│                   ┌────────▼────────┐                        │
│                   │  协议层         │                        │
│                   │  - 编码/解码    │                        │
│                   │  - 连接管理     │                        │
│                   └────────┬────────┘                        │
└────────────────────────────┼─────────────────────────────────┘
                             │
                    TCP 长连接 (Wi-Fi)
                             │
┌────────────────────────────┼─────────────────────────────────┐
│                     服务端层                                 │
│                            │                                 │
│         ┌──────────────────▼──────────────────┐             │
│         │        协议网关 (Gateway)            │             │
│         │  - 连接管理                          │             │
│         │  - 协议解析                          │             │
│         │  - 路由分发                          │             │
│         └───────┬────────────────┬─────────────┘             │
│                 │                │                            │
│    ┌────────────▼─────┐  ┌──────▼────────────┐              │
│    │   音频处理管道    │  │   控制消息处理     │              │
│    │                  │  │                    │              │
│    │  ┌────────────┐  │  │  - 按键事件        │              │
│    │  │   ASR      │  │  │  - 打断信号        │              │
│    │  │ (Whisper)  │  │  │  - 状态同步        │              │
│    │  └─────┬──────┘  │  └────────────────────┘              │
│    │        │         │                                       │
│    │  ┌─────▼──────┐  │                                       │
│    │  │   Agent    │  │                                       │
│    │  │  (Agno)    │  │                                       │
│    │  └─────┬──────┘  │                                       │
│    │        │         │                                       │
│    │  ┌─────▼──────┐  │                                       │
│    │  │    LLM     │  │                                       │
│    │  │  (Stream)  │  │                                       │
│    │  └─────┬──────┘  │                                       │
│    │        │         │                                       │
│    │  ┌─────▼──────┐  │                                       │
│    │  │    TTS     │  │                                       │
│    │  │  (Stream)  │  │                                       │
│    │  └─────┬──────┘  │                                       │
│    └────────┼─────────┘                                       │
│             │                                                  │
│    ┌────────▼─────────┐                                       │
│    │   会话管理        │                                       │
│    │  - 上下文存储     │                                       │
│    │  - 用户状态       │                                       │
│    │  - 历史记录       │                                       │
│    └──────────────────┘                                       │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 MCU 终端架构

#### 2.2.1 硬件层

- **主控芯片**：ESP32-S3（推荐）
  - Wi-Fi + 蓝牙双模
  - I2S 音频接口
  - PSRAM 支持
  - Rust 生态成熟

- **音频接口**：
  - 输入：I2S/PDM 麦克风
  - 输出：I2S DAC 或 I2S 功放

- **用户交互**：
  - 按键：PTT（Push-to-Talk）按键
  - LED：状态指示（IDLE/LISTENING/THINKING/SPEAKING）

#### 2.2.2 软件层

```
┌─────────────────────────────────────┐
│        应用层 (Application)         │
│  - 状态机管理                        │
│  - 用户交互处理                      │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│        音频层 (Audio)                │
│  - 音频采集 (16kHz, mono, PCM)       │
│  - 音频播放 (PCM stream)             │
│  - Buffer 管理                      │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│        协议层 (Protocol)             │
│  - 二进制协议编码/解码               │
│  - TCP 连接管理                      │
│  - 重连机制                          │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│        硬件抽象层 (HAL)              │
│  - I2S 驱动                         │
│  - Wi-Fi 驱动                       │
│  - GPIO 驱动                        │
└─────────────────────────────────────┘
```

### 2.3 服务端架构

#### 2.3.1 服务分层

```
┌─────────────────────────────────────────────┐
│            API Gateway Layer                │
│  - WebSocket/TCP Server                      │
│  - 协议解析                                  │
│  - 连接管理                                  │
│  - 路由分发                                  │
└──────────────┬──────────────────────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
┌───▼────────┐    ┌───────▼────────┐
│ 音频处理   │    │  控制处理       │
│ Pipeline   │    │                 │
└───┬────────┘    └─────────────────┘
    │
┌───▼────────────────────────────────────┐
│         ASR Service                      │
│  - faster-whisper                       │
│  - 流式识别                              │
│  - VAD (可选)                           │
└───┬────────────────────────────────────┘
    │
┌───▼────────────────────────────────────┐
│         Agent Service                   │
│  - Agno Framework                       │
│  - Tool Calling                         │
│  - 决策调度                              │
└───┬────────────────────────────────────┘
    │
┌───▼────────────────────────────────────┐
│         LLM Service                     │
│  - OpenAI / Anthropic / Local          │
│  - 流式响应                              │
└───┬────────────────────────────────────┘
    │
┌───▼────────────────────────────────────┐
│         TTS Service                     │
│  - OpenAI TTS / Azure / Local          │
│  - 流式合成                              │
└───┬────────────────────────────────────┘
    │
┌───▼────────────────────────────────────┐
│         Session Manager                 │
│  - 上下文存储 (Redis/DB)                │
│  - 用户状态管理                          │
│  - 历史记录                              │
└────────────────────────────────────────┘
```

## 三、技术选型

### 3.1 MCU 终端技术栈

| 层级           | 技术选型           | 说明                             |
| -------------- | ------------------ | -------------------------------- |
| **硬件平台**   | ESP32-S3           | Wi-Fi + BT，I2S，PSRAM，性价比高 |
| **编程语言**   | Rust (no_std)      | 内存安全，状态机友好，无 GC      |
| **嵌入式框架** | esp-rs / embassy   | Rust 嵌入式生态                  |
| **音频处理**   | I2S HAL            | 硬件 I2S 接口                    |
| **网络通信**   | esp-idf-sys / smol | TCP 客户端                       |
| **状态机**     | 自实现 FSM         | 明确的状态转换                   |

### 3.2 服务端技术栈

| 模块           | 技术选型                       | 说明                       |
| -------------- | ------------------------------ | -------------------------- |
| **ASR**        | faster-whisper                 | 本地部署，低延迟，高准确率 |
| **Agent 框架** | Agno                           | 已集成，支持 Tool Calling  |
| **LLM**        | OpenAI / Anthropic / Local     | 支持多种 LLM 后端          |
| **TTS**        | OpenAI TTS / Azure TTS / Piper | 流式合成，低延迟           |
| **协议网关**   | Python (FastAPI/WebSocket)     | 或 Go (gorilla/websocket)  |
| **会话存储**   | Redis                          | 快速上下文存储             |
| **数据库**     | PostgreSQL                     | 历史记录、用户数据         |
| **部署**       | Docker + Docker Compose        | 容器化部署                 |

### 3.3 通信协议

- **传输层**：TCP 长连接
- **协议格式**：自定义二进制协议
- **特点**：
  - 低延迟（无 JSON 解析开销）
  - 固定帧长（音频帧）
  - 类型明确（控制帧 vs 数据帧）

## 四、通信协议设计

### 4.1 协议格式

#### 4.1.1 控制帧（Control Frame）

```
┌──────┬──────┬──────────┐
│ TYPE │ LEN  │ PAYLOAD  │
│(1B)  │(2B)  │ (0-255B) │
└──────┴──────┴──────────┘
```

**TYPE 定义**：

| 类型值 | 名称          | 方向         | 说明       |
| ------ | ------------- | ------------ | ---------- |
| 0x01   | START_CAPTURE | MCU → Server | 开始录音   |
| 0x02   | AUDIO_DATA    | MCU → Server | 音频数据   |
| 0x03   | END_CAPTURE   | MCU → Server | 结束录音   |
| 0x04   | INTERRUPT     | MCU → Server | 用户打断   |
| 0x10   | AUDIO_START   | Server → MCU | 开始播放   |
| 0x11   | AUDIO_CHUNK   | Server → MCU | 音频数据块 |
| 0x12   | AUDIO_END     | Server → MCU | 播放结束   |
| 0x20   | HEARTBEAT     | 双向         | 心跳       |
| 0x21   | ACK           | 双向         | 确认       |
| 0x30   | ERROR         | 双向         | 错误消息   |

#### 4.1.2 音频帧（Audio Frame）

```
┌──────┬──────┬──────────┬──────────────┐
│ TYPE │ SEQ  │ TIMESTAMP│   PCM DATA   │
│(1B)  │(2B)  │  (4B)    │  (固定长度)   │
└──────┴──────┴──────────┴──────────────┘
```

**参数说明**：

- **TYPE**: 0x02 (AUDIO_DATA) 或 0x11 (AUDIO_CHUNK)
- **SEQ**: 序列号，用于检测丢包
- **TIMESTAMP**: 时间戳（毫秒）
- **PCM DATA**:
  - 采样率：16kHz
  - 位深：16-bit
  - 声道：Mono
  - 帧长：20ms (640 bytes)

#### 4.1.3 控制帧 Payload 示例

**START_CAPTURE (0x01)**:

```
┌──────────────┐
│ SESSION_ID   │ (16 bytes, UUID)
└──────────────┘
```

**INTERRUPT (0x04)**:

```
┌──────────────┐
│ REASON       │ (1 byte: 0=按键, 1=超时, 2=其他)
└──────────────┘
```

**ERROR (0x30)**:

```
┌──────────────┬──────────────┐
│ ERROR_CODE   │ ERROR_MSG    │
│ (2 bytes)    │ (变长字符串)  │
└──────────────┴──────────────┘
```

### 4.2 协议流程

#### 4.2.1 正常对话流程

```
MCU                           Server
 │                              │
 │─── START_CAPTURE (0x01) ────>│
 │                              │─── ASR 开始 ──┐
 │                              │              │
 │─── AUDIO_DATA (0x02) ───────>│              │
 │                              │              │
 │─── AUDIO_DATA (0x02) ───────>│              │
 │                              │              │
 │─── END_CAPTURE (0x03) ───────>│              │
 │                              │<── ASR 结束 ─┘
 │                              │─── Agent 处理 ──┐
 │                              │                 │
 │                              │<── LLM 响应 ────┤
 │                              │                 │
 │                              │<── TTS 合成 ─────┘
 │<── AUDIO_START (0x10) ───────│
 │                              │
 │<── AUDIO_CHUNK (0x11) ───────│
 │                              │
 │<── AUDIO_CHUNK (0x11) ───────│
 │                              │
 │<── AUDIO_END (0x12) ──────────│
 │                              │
```

#### 4.2.2 打断流程

```
MCU                           Server
 │                              │
 │<── AUDIO_CHUNK (0x11) ───────│ (正在播放)
 │                              │
 │─── INTERRUPT (0x04) ────────>│
 │                              │─── 立即停止 TTS ──┐
 │                              │                  │
 │                              │<── 停止播放 ──────┘
 │<── AUDIO_END (0x12) ─────────│
 │                              │
 │─── START_CAPTURE (0x01) ────>│ (新对话)
 │                              │
```

### 4.3 错误处理

- **连接断开**：MCU 自动重连（指数退避）
- **丢包检测**：通过 SEQ 检测，服务端请求重传
- **超时处理**：
  - 录音超时：30 秒自动结束
  - 响应超时：10 秒返回错误
  - 心跳超时：30 秒断开重连

## 五、MCU 状态机设计

### 5.1 状态定义

```rust
enum TerminalState {
    IDLE,              // 空闲状态
    CAPTURE_AUDIO,     // 正在录音
    UPLOAD_AUDIO,      // 上传音频（可选，可合并到 CAPTURE）
    WAIT_RESPONSE,     // 等待服务端响应
    PLAY_AUDIO,        // 正在播放
    ERROR,             // 错误状态
    RECONNECTING,      // 重连中
}
```

### 5.2 状态转换图

```
        [启动]
          │
          ▼
       IDLE ◄──────────────────┐
          │                     │
    [按键按下]                   │
          │                     │
          ▼                     │
   CAPTURE_AUDIO                │
          │                     │
    [按键松开/超时]              │
          │                     │
          ▼                     │
   WAIT_RESPONSE                │
          │                     │
    [收到音频]                  │
          │                     │
          ▼                     │
    PLAY_AUDIO ───[打断]────────┘
          │
    [播放完成]
          │
          ▼
       IDLE

    [连接断开]
          │
          ▼
   RECONNECTING
          │
    [重连成功]
          │
          ▼
       IDLE
```

### 5.3 状态机实现要点

- **原子性**：状态转换必须是原子的
- **事件驱动**：按键、网络消息、定时器触发状态转换
- **超时保护**：每个状态都有超时机制
- **错误恢复**：ERROR 状态自动尝试恢复

## 六、服务端设计

### 6.1 协议网关

**职责**：

- TCP 服务器监听
- 协议解析（二进制 → 结构化数据）
- 连接管理（心跳、重连）
- 路由分发（音频流 vs 控制消息）

**实现要点**：

- 异步 I/O（asyncio / tokio）
- 连接池管理
- 背压控制（防止音频 buffer 溢出）

### 6.2 音频处理管道

**ASR 模块**：

- 输入：PCM 音频流（16kHz, mono）
- 输出：文本（流式）
- 技术：faster-whisper
- 优化：VAD 检测（可选，服务端做）

**Agent 模块**：

- 框架：Agno
- 输入：ASR 文本 + 上下文
- 输出：LLM 响应（流式）
- 功能：Tool Calling、多轮对话

**TTS 模块**：

- 输入：文本（流式）
- 输出：PCM 音频流（16kHz, mono）
- 技术：OpenAI TTS / Azure / 本地模型
- 优化：流式合成，低延迟首帧

### 6.3 会话管理

**存储结构**：

```python
{
    "session_id": "uuid",
    "user_id": "user_xxx",
    "context": [
        {"role": "user", "content": "..."},
        {"role": "assistant", "content": "..."}
    ],
    "metadata": {
        "created_at": "...",
        "last_active": "...",
        "device_id": "..."
    }
}
```

**存储方案**：

- **Redis**：活跃会话（TTL: 1小时）
- **PostgreSQL**：历史记录（长期存储）

## 七、部署方案

### 7.1 开发环境

**MCU 模拟器**（PC 端）：

- Python 脚本模拟 MCU 行为
- 发送 PCM 音频文件
- 接收并保存 TTS 音频

**服务端本地部署**：

```bash
# Docker Compose
docker-compose up -d

# 或直接运行
python -m uvicorn server.main:app --reload
```

### 7.2 生产环境

**边缘设备部署**（推荐）：

- **硬件**：Raspberry Pi 5 / Intel N100 mini PC
- **系统**：Ubuntu Server 22.04
- **部署**：Docker Compose
- **服务**：
  - 协议网关
  - ASR 服务
  - Agent 服务
  - TTS 服务
  - Redis
  - PostgreSQL（可选）

**云端部署**（可选）：

- 如果 MCU 通过 Wi-Fi 直连云端
- 使用 K8s 或云服务（ECS/EKS）

### 7.3 部署架构

```
┌─────────────────────────────────────┐
│     边缘设备 (Raspberry Pi 5)       │
│                                     │
│  ┌──────────────────────────────┐  │
│  │  Docker Compose              │  │
│  │  - Gateway Service           │  │
│  │  - ASR Service               │  │
│  │  - Agent Service             │  │
│  │  - TTS Service               │  │
│  │  - Redis                      │  │
│  └──────────────────────────────┘  │
│                                     │
│  ┌──────────────────────────────┐  │
│  │  MCU 终端 (ESP32-S3)         │  │
│  │  - Wi-Fi 连接                │  │
│  │  - TCP 直连服务端            │  │
│  └──────────────────────────────┘  │
└─────────────────────────────────────┘
         │
         │ (可选)
         ▼
┌─────────────────────────────────────┐
│      云端服务 (可选)                 │
│  - LLM API (OpenAI/Anthropic)       │
│  - TTS API (OpenAI/Azure)           │
│  - 用户数据同步                      │
└─────────────────────────────────────┘
```

## 八、性能指标

### 8.1 延迟预算

| 阶段               | 目标延迟 | 说明                         |
| ------------------ | -------- | ---------------------------- |
| **ASR 首字**       | < 300ms  | 用户说完第一个字到识别出文本 |
| **Agent 首 token** | < 500ms  | ASR 完成到 LLM 开始响应      |
| **TTS 首帧**       | < 300ms  | LLM 开始响应到音频首帧       |
| **端到端**         | < 1.5s   | 用户说完到听到回复首字       |

### 8.2 资源需求

**MCU (ESP32-S3)**：

- RAM: 512KB+ (PSRAM)
- Flash: 4MB+
- CPU: 240MHz (双核)

**服务端 (边缘设备)**：

- CPU: 4 核+
- RAM: 8GB+
- 存储: 32GB+ (SSD)
- 网络: 100Mbps+

## 九、开发路线图

### Phase 1: MVP (2-3 周)

- [ ] MCU 端：音频采集 + TCP 连接
- [ ] 服务端：协议网关 + ASR (Whisper)
- [ ] 服务端：Agent 集成 (Agno)
- [ ] 服务端：TTS (OpenAI TTS)
- [ ] 基础状态机（MCU）
- [ ] PC 端模拟器（测试用）

### Phase 2: 完善功能 (2-3 周)

- [ ] 打断功能（barge-in）
- [ ] 会话管理（Redis）
- [ ] 错误处理与重连
- [ ] 心跳机制
- [ ] 性能优化（延迟优化）

### Phase 3: 生产就绪 (2-3 周)

- [ ] 部署方案（Docker Compose）
- [ ] 监控与日志
- [ ] 固件 OTA 升级
- [ ] 压力测试
- [ ] 文档完善

## 十、关键技术决策

### 10.1 为什么选择自定义二进制协议？

- **低延迟**：无 JSON 解析开销
- **高效**：固定帧长，易于 buffer 管理
- **可靠**：明确的类型和长度字段
- **简单**：MCU 端实现简单

### 10.2 为什么 MCU 不做 ASR/VAD？

- **算力限制**：MCU 算力不足以运行 Whisper
- **功耗考虑**：本地 ASR 功耗高
- **灵活性**：服务端可以快速升级模型
- **成本**：服务端算力成本更低

### 10.3 为什么选择 Rust for MCU？

- **内存安全**：避免野指针、缓冲区溢出
- **状态机友好**：类型系统天然支持 FSM
- **无 GC**：实时性保证
- **生态成熟**：esp-rs 生态完善

### 10.4 为什么服务端用 Python？

- **模型生态**：Whisper、TTS 模型主要在 Python
- **Agent 框架**：Agno 是 Python
- **快速迭代**：开发效率高
- **部署简单**：Docker 容器化

## 十一、风险与应对

### 11.1 技术风险

| 风险             | 影响 | 应对措施                            |
| ---------------- | ---- | ----------------------------------- |
| **网络不稳定**   | 高   | 自动重连、本地缓存、降级方案        |
| **延迟过高**     | 高   | 流式处理、预加载、边缘部署          |
| **MCU 资源不足** | 中   | 优化 buffer、减少分配、选择合适芯片 |
| **服务端崩溃**   | 中   | 健康检查、自动重启、优雅降级        |

### 11.2 工程风险

| 风险             | 影响 | 应对措施                   |
| ---------------- | ---- | -------------------------- |
| **协议不兼容**   | 中   | 版本管理、向后兼容         |
| **固件升级困难** | 中   | OTA 升级、回滚机制         |
| **调试困难**     | 中   | 日志系统、远程调试、模拟器 |

## 十二、后续优化方向

1. **本地模型**：在边缘设备部署小模型（如 Qwen2.5-1.5B）
2. **唤醒词**：集成唤醒词检测（如 Porcupine）
3. **多设备**：支持一个服务端服务多个 MCU
4. **离线模式**：完全本地化，不依赖云端
5. **蓝牙集成**：MCU 直接连接蓝牙音箱（HFP/A2DP）

---

**文档版本**: v1.0  
**最后更新**: 2025-01-22
**维护者**: Yanshu Team
