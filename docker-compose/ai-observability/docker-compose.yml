version: '3.8'

services:
  # PostgreSQL database for Langfuse
  postgres:
    image: postgres:15-alpine
    container_name: langfuse-postgres
    environment:
      POSTGRES_USER: langfuse
      POSTGRES_PASSWORD: langfuse
      POSTGRES_DB: langfuse
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-observability

  # Langfuse - LLM Observability Platform
  langfuse:
    image: langfuse/langfuse:latest
    container_name: langfuse
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://langfuse:langfuse@postgres:5432/langfuse
      NEXTAUTH_SECRET: langfuse-secret-key-change-in-production
      NEXTAUTH_URL: http://localhost:3000
      SALT: langfuse-salt-change-in-production
      LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: "true"
    ports:
      - "3000:3000"
    volumes:
      - langfuse_data:/app/data
    networks:
      - ai-observability
    restart: unless-stopped

  # LiteLLM - Unified LLM API Proxy
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm
    depends_on:
      - langfuse
    environment:
      # Langfuse integration
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-your-langfuse-secret-key}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-your-langfuse-public-key}
      LANGFUSE_HOST: http://langfuse:3000
      
      # LiteLLM configuration
      LITELLM_LOG: INFO
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-1234}
      
      # Optional: Add your API keys for various providers
      # OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      # GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
    ports:
      - "4000:4000"
    volumes:
      - ./litellm_config.yaml:/app/config.yaml:ro
      - litellm_data:/app/data
    command: --config /app/config.yaml
    networks:
      - ai-observability
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  langfuse_data:
    driver: local
  litellm_data:
    driver: local

networks:
  ai-observability:
    driver: bridge
