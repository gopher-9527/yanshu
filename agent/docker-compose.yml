version: '3.8'

# Agent 服务 Docker Compose（开发/测试用）
# 生产环境建议使用 docker-compose/caddy/docker-compose.full.yml

services:
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yanshu-agent
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - CONFIG_PATH=/app/config.yaml
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - MODEL_NAME=${MODEL_NAME:-deepseek/deepseek-v3.2-251201}
      - MODEL_BASE_URL=${MODEL_BASE_URL:-https://api.qnaigc.com}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      # 挂载配置文件（可选，也可以使用环境变量）
      - ./config.yaml:/app/config.yaml:ro
      # 或使用配置模板
      # - ./config.yaml.example:/app/config.yaml.example:ro
    networks:
      - yanshu-network
    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # 开发模式（使用 Dockerfile.dev）
  # agent-dev:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.dev
  #   container_name: yanshu-agent-dev
  #   ports:
  #     - "8080:8080"
  #   volumes:
  #     - .:/app
  #     - go-mod-cache:/go/pkg/mod
  #   environment:
  #     - CONFIG_PATH=/app/config.yaml
  #     - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
  #     - LOG_LEVEL=debug
  #   networks:
  #     - yanshu-network
  #   command: ["go", "run", "./cmd/agent.go", "web", "api", "webui"]

# volumes:
#   go-mod-cache:
#     driver: local

networks:
  yanshu-network:
    driver: bridge
